# Metasploit Payloads: Concepts, Formats, and Modern Considerations (2025)

> **For authorized lab use and defensive study only.**  
> Always obtain explicit written permission before testing.

---

## Core Concepts (High-Level)

### Payload Types
- **Meterpreter**: Feature-rich, in-memory post-exploitation payload.
- **Simple Shells**: Reverse shell (connects back) or bind shell (listens on target).
- **Staged vs. Stageless**:
  - **Staged**: Small initial payload fetches larger stages post-connection.
  - **Stageless**: Self-contained payload (larger but more reliable).

### Transports
- **`reverse_tcp`**: Direct TCP connection (noisy, easily blocked).
- **`reverse_http(s)`**: Blends with web traffic (better for egress filtering).

### Key Terms
- **LHOST/LPORT**: Listener IP/port for callback.
- **Architecture**: Must match target (x64/x86/ARM).
- **AV/EDR Reality**: Modern defenses detect generic payloads via behavior/reputation.

---

## File Formats by Platform

| Platform       | Binary Format          | Common Extensions | Notes                                                                 |
|----------------|------------------------|-------------------|-----------------------------------------------------------------------|
| **Windows**    | PE/PE32+               | `.exe`, `.dll`    | Unsigned binaries often blocked. Prefer x64 for modern systems.      |
| **Linux**      | ELF                    | (none) or `.elf`  | Requires executable bit (`chmod +x`).                                |
| **macOS**      | Mach-O (in `.app`)     | `.app`            | Gatekeeper blocks unsigned/unnotarized binaries.                     |
| **Android**    | APK                    | `.apk`            | Requires signing; sideloading restricted.                            |
| **iOS**        | Mach-O (in `.ipa`)     | `.ipa`            | Execution tightly controlled (requires valid signing).               |
| **Web/PHP**    | Interpreted script     | `.php`            | Runs under a web server (not a native binary).                       |
| **Java**       | JAR/WAR                | `.jar`, `.war`    | Subject to runtime policies.                                         |

---

## Authorized Lab Workflow (Conceptual)

1. **Plan and Scope**  
   - Confirm written authorization, target systems, and testing windows.  
   - Document deconfliction procedures.

2. **Payload Generation**  
   - Match platform/architecture (e.g., `windows/x64/meterpreter/reverse_https`).  
   - Use modern transports (HTTPS over TCP where possible).  

3. **Controlled Delivery**  
   - Transfer payloads via approved methods (SCP, HTTP server).  
   - Log all actions for audit trails.  

4. **Listener Setup**  
   - Configure handler to match payload (transport, port, options).  

5. **Execution**  
   - Trigger payload via consented mechanisms (e.g., user interaction in lab).  

6. **Post-Exploitation**  
   - Verify session (e.g., `sysinfo`, `getuid`).  
   - Avoid persistence unless explicitly approved.  

7. **Cleanup**  
   - Remove artifacts, revert changes, and document findings.  

---

## Modern Realities (2025)

### Evasion Challenges
- **Encoders**: Legacy tools like `shikata_ga_nai` are ineffective against EDR.  
- **Signing/Reputation**: Unsigned binaries are flagged; use legitimate templates cautiously.  
- **Behavioral Detections**: Process injection, network beacons, and credential access trigger alerts.  

### Platform-Specific Protections
- **macOS/iOS**: Gatekeeper, SIP, and notarization block untrusted code.  
- **Android**: Play Protect scans APKs; background execution restricted.  
- **Windows**: Smart App Control and Defender ASR rules limit unsigned code.  

### Operational Tips
- **Prefer HTTPS**: Blends with web traffic (bypasses egress filters).  
- **Avoid Persistence**: Noisy and often unnecessary for lab testing.  
- **Log Everything**: Critical for compliance and reporting.  

---

## Defensive Notes (Blue Team)

### Detection Strategies
- **Network**: Monitor for unusual outbound HTTPS connections (JA3 fingerprints).  
- **Endpoint**: Alert on unsigned binaries spawning network connections.  
- **Application Control**: Enforce code signing (e.g., Windows Defender Application Control).  

### Mitigations
- **macOS**: Enable Gatekeeper and Notarization.  
- **Windows**: Deploy ASR rules and LSA protection.  
- **Linux**: Restrict `exec` permissions and audit `ptrace`.  

---

## Quick Reference

### Payload Formats
- **Windows**: `.exe` (PE/PE32+).  
- **Linux**: `.elf` (ELF).  
- **macOS**: `.app` (Mach-O).  
- **Android**: `.apk`.  

### Safe Resources
- [Metasploit Unleashed](https://www.offsec.com/metasploit-unleashed/)  
- [MITRE ATT&CK](https://attack.mitre.org/)  
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)  

---

## About This Note
- **Purpose**: Conceptual guidance for authorized labs.  
- **Exclusions**: No step-by-step exploitation commands (compliance-safe).  
- **Tailoring**: Share lab constraints (OS, network rules) for specific advice.  

> **Reminder**: Unauthorized testing violates laws/policies. Always operate within scope.  
